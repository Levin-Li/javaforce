package javaforce.utils;

import javaforce.*;
import java.io.*;
import java.util.*;
import javax.swing.JFileChooser;
import javax.swing.filechooser.FileNameExtensionFilter;
        
/**
 *
 * Created : Oct 28, 2015
 *
 * @author pquiring
 */
public class RunAs extends javax.swing.JFrame {

  /**
   * Creates new form RunAs
   */
  public RunAs() {
    initComponents();
    JF.centerWindow(this);
    JF.assignHotKey(this.getRootPane(), cancel, java.awt.event.KeyEvent.VK_ESCAPE);
    JF.assignHotKey(this.getRootPane(), execute, java.awt.event.KeyEvent.VK_ENTER);
    loadApps();
  }

  /**
   * This method is called from within the constructor to initialize the form.
   * WARNING: Do NOT modify this code. The content of this method is always
   * regenerated by the Form Editor.
   */
  @SuppressWarnings("unchecked")
  // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
  private void initComponents() {

    jLabel4 = new javax.swing.JLabel();
    jLabel1 = new javax.swing.JLabel();
    program = new javax.swing.JComboBox();
    jLabel2 = new javax.swing.JLabel();
    username = new javax.swing.JTextField();
    jLabel3 = new javax.swing.JLabel();
    password = new javax.swing.JPasswordField();
    execute = new javax.swing.JButton();
    cancel = new javax.swing.JButton();
    jLabel5 = new javax.swing.JLabel();
    domain = new javax.swing.JTextField();
    pick = new javax.swing.JButton();

    jLabel4.setText("jLabel4");

    setDefaultCloseOperation(javax.swing.WindowConstants.EXIT_ON_CLOSE);
    setTitle("RunAs");

    jLabel1.setText("Application");

    program.setEditable(true);

    jLabel2.setText("Username");

    jLabel3.setText("Password");

    execute.setText("Execute");
    execute.addActionListener(new java.awt.event.ActionListener() {
      public void actionPerformed(java.awt.event.ActionEvent evt) {
        executeActionPerformed(evt);
      }
    });

    cancel.setText("Cancel");
    cancel.addActionListener(new java.awt.event.ActionListener() {
      public void actionPerformed(java.awt.event.ActionEvent evt) {
        cancelActionPerformed(evt);
      }
    });

    jLabel5.setText("Domain");

    pick.setText("Select");
    pick.addActionListener(new java.awt.event.ActionListener() {
      public void actionPerformed(java.awt.event.ActionEvent evt) {
        pickActionPerformed(evt);
      }
    });

    javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
    getContentPane().setLayout(layout);
    layout.setHorizontalGroup(
      layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
      .addGroup(layout.createSequentialGroup()
        .addContainerGap()
        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
          .addGroup(layout.createSequentialGroup()
            .addGap(0, 0, Short.MAX_VALUE)
            .addComponent(cancel)
            .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
            .addComponent(execute))
          .addGroup(layout.createSequentialGroup()
            .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
              .addComponent(jLabel2)
              .addComponent(jLabel5)
              .addComponent(jLabel1)
              .addComponent(jLabel3))
            .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
            .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
              .addComponent(password)
              .addComponent(domain)
              .addComponent(username)
              .addGroup(layout.createSequentialGroup()
                .addComponent(program, 0, 451, Short.MAX_VALUE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(pick)))))
        .addContainerGap())
    );
    layout.setVerticalGroup(
      layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
      .addGroup(layout.createSequentialGroup()
        .addContainerGap()
        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
          .addComponent(jLabel1)
          .addComponent(program, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
          .addComponent(pick))
        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
          .addComponent(jLabel5)
          .addComponent(domain, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
          .addComponent(jLabel2)
          .addComponent(username, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
          .addComponent(jLabel3)
          .addComponent(password, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
          .addComponent(execute)
          .addComponent(cancel))
        .addContainerGap())
    );

    pack();
  }// </editor-fold>//GEN-END:initComponents

  private void cancelActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_cancelActionPerformed
    System.exit(0);
  }//GEN-LAST:event_cancelActionPerformed

  private void executeActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_executeActionPerformed
    String app = (String)program.getSelectedItem();
    if (app == null || app.length() == 0) return;
    saveApps();
    String dom = domain.getText();
    if (dom.length() == 0) {
      dom = System.getenv("COMPUTERNAME");
    }
    String user = username.getText();
    String pass = new String(password.getPassword());
    ArrayList<String> cmd = new ArrayList<String>();
    cmd.add("psexec.exe");
    cmd.add("-d");
    cmd.add("-u");
    cmd.add(dom + "\\" + user);
    cmd.add("-p");
    cmd.add(pass);
    String cl[] = ((String)program.getSelectedItem()).split("[|]");
    for(int a=0;a<cl.length;a++) {
      cmd.add(cl[a]);
    }
    String ca[] = cmd.toArray(new String[cmd.size()]);
/*
    String out = "";
    for(int a=0;a<ca.length;a++) {
      out += " ";
      out += ca[a];
    }
    JF.showMessage("test", out);
*/
    try {
      ShellProcess sp = new ShellProcess();
      sp.run(ca, true);
      System.exit(0);
    } catch (Exception e) {
      JF.showError("Error", e.toString());
    }
  }//GEN-LAST:event_executeActionPerformed

  private void pickActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_pickActionPerformed
    JFileChooser chooser = new JFileChooser();
    chooser.setFileSelectionMode(JFileChooser.FILES_ONLY);
    chooser.setMultiSelectionEnabled(false);
    chooser.setFileFilter(new FileNameExtensionFilter("Application (*.exe)", "exe"));
    chooser.setCurrentDirectory(new File(JF.getCurrentPath()));
    if (chooser.showOpenDialog(this) != JFileChooser.APPROVE_OPTION) return;
    program.addItem(chooser.getSelectedFile().toString());
    program.setSelectedIndex(program.getItemCount()-1);
  }//GEN-LAST:event_pickActionPerformed

  /**
   * @param args the command line arguments
   */
  public static void main(String args[]) {
    /* Create and display the form */
    java.awt.EventQueue.invokeLater(new Runnable() {
      public void run() {
        new RunAs().setVisible(true);
      }
    });
  }

  // Variables declaration - do not modify//GEN-BEGIN:variables
  private javax.swing.JButton cancel;
  private javax.swing.JTextField domain;
  private javax.swing.JButton execute;
  private javax.swing.JLabel jLabel1;
  private javax.swing.JLabel jLabel2;
  private javax.swing.JLabel jLabel3;
  private javax.swing.JLabel jLabel4;
  private javax.swing.JLabel jLabel5;
  private javax.swing.JPasswordField password;
  private javax.swing.JButton pick;
  private javax.swing.JComboBox<String> program;
  private javax.swing.JTextField username;
  // End of variables declaration//GEN-END:variables

  public static final String apps = "runas_apps.ini";
  
  public void loadApps() {
    try {
      BufferedReader br = new BufferedReader(new FileReader(apps));
      String ln;
      while ((ln = br.readLine()) != null) {
        if (ln.length() > 0) {
          program.addItem(ln);
        }
      }
      br.close();
    } catch (Exception e) {
      e.printStackTrace();
    }
  }
  
  public void saveApps() {
    try {
      BufferedWriter bw = new BufferedWriter(new FileWriter(apps));
      int cnt = program.getItemCount();
      for(int a=0;a<cnt;a++) {
        String ln = program.getItemAt(a);
        bw.write(ln, 0, ln.length());
        bw.write("\r\n", 0, 2);
      }
      bw.close();
    } catch (Exception e) {
      e.printStackTrace();
    }
  }
}
